# Scheduled Backups

This example shows how to use Cloud Scheduler and Cloud Functions to configure a schedule that creates Cloud Bigtable backups periodically.

## Create scheduled backups

1. Clone this directory and make changes to `./config/scheduled-backups.properties` file to match your configuration.

2. Create a Cloud Pub/Sub topic `cbt-scheduled-backups` for scheduled backups. For example:

```
gcloud pubsub topics create cloud-bigtable-scheduled-backups --project <project-id>
```

3. Create and deploy a Cloud Function `cbt-create-backup-function` which is called whenever a Pub/Sub message arrives in `cbt-scheduled-backups` topic:

```
./scripts/scheduled_backups.sh deploy-backup-function
```

4. Deploy the scheduled backup configuration to Cloud Scheduler:

```
./scripts/scheduled_backups.sh create-schedule
```

## Email notification of backup failures
To get email notification, follow these steps:

1. Follow this [guide](https://cloud.google.com/monitoring/support/notification-options#email) to add your email address as a notification channel.

2. Create and deploy a custom metrics configuration file to filter logs generated by Cloud Functions, Cloud Scheduler and Cloud Bigtable.
We use [Deployment Manager](https://cloud.google.com/deployment-manager/docs/quickstart) to create custom metrics. 
The example file can be found in `./config/metrics.yaml`. Deploy the custom metrics in Cloud Logging:

```
./scripts/scheduled_backups.sh add-metrics
```
After this, you should see two user-defined metrics under `Logs-based Metrics` in Cloud Logging.

3. Go to `Logs-based Metrics` in Cloud Logging and select `Create alert from metric` option for each of the two metrics created in the above step.
From there, you can choose `Aggregrator`, such as `sum` or `mean`, for the target metric, and define what the condition of triggering an alert is,
e.g., any time series violates that the value is above 0 for 1 minute.

Then add notification channels you just created to alerting policies.

### APIs and IAM roles setup

<img src="https://drive.google.com/uc?export=view&id=1YHUh5FKSuNMTSj6_E7Ehsq31RHNPu2Wu" width="600" height="auto" />

The above diagram shows the Google Cloud products involved in this scheduled backup solution and action flows between them.

The administrator should be granted specific roles to deploy the services needed for the solution.

### Limitations
